<!DOCTYPE html>
<html>
<head>
  <title>Now Playing</title>
</head>
<body style="font-family:sans-serif; text-align:center; margin-top:50px;">
  <h1>Now Playing</h1>

  <button onclick="login()">Login Spotify</button>

  <h2 id="song">-</h2>

  <button onclick="tweet()">Tweet Now Playing</button>

  <script>
    const clientId = "6844de5da19b4b6e8a4aac2f7517cb16";
    const redirectUri = window.location.origin;

    function login() {
      const scope = "user-read-currently-playing";
      window.location = `https://accounts.spotify.com/authorize?client_id=${clientId}&response_type=token&redirect_uri=${redirectUri}&scope=${scope}`;
    }

    function getToken() {
      const hash = window.location.hash;
      if (!hash) return null;
      return hash.split("&")[0].split("=")[1];
    }

    async function getNowPlaying() {
      const token = getToken();
      if (!token) return;

      const res = await fetch("https://api.spotify.com/v1/me/player/currently-playing", {
        headers: { Authorization: "Bearer " + token }
      });

      const data = await res.json();

      if (data && data.item) {
        const title = data.item.name;
        const artist = data.item.artists[0].name;
        const url = data.item.external_urls.spotify;

        const text = `${title} - ${artist} #nowplaying ${url}`;

        document.getElementById("song").innerText = text;

        window.tweetText = text;
      }
    }

    function tweet() {
      if (!window.tweetText) return alert("No song detected");
      const url = "https://twitter.com/intent/tweet?text=" + encodeURIComponent(window.tweetText);
      window.open(url, "_blank");
    }

    getNowPlaying();
  </script>
</body>
</html>

